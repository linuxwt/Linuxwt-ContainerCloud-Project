kind: ConfigMap
apiVersion: v1
metadata:
  name: fluentd-config
data:
  containers.input.conf: |-   
    <source>
      @type tail
      path /usr/local/nginx/logs/access.log
      pos_file /usr/local/nginx/logs/access.log.pos
      tag nginx.access
        <parse>
          @type json
          time_type string
          time_format %d/%b/%Y:%H:%M:%S %z
        </parse>
    </source>
  output.conf: |-
      <match nginx.access>
        @type elasticsearch
        host elasticsearch-service.monitor
        port 9200
        logstash_prefix nginx-access
        time_key time
        flush_interval 1s
        logstash_format true
        reconnect_on_error true
        reload_on_failure true
        reload_connections false
        request_timeout 20
      </match>
  nginx.conf: |-
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log notice;
    pid        /var/run/nginx.pid;


    events {
        worker_connections  1024;
    }


    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;
        log_format main '{ "@timestamp": "$time_iso8601", '
                         '"@fields": { '
                         '"remote_addr": "$remote_addr", '
                         '"remote_user": "$remote_user", '
                         '"body_bytes_sent": "$body_bytes_sent", '
                         '"request_time": "$request_time", '
                         '"status": "$status", '
                         '"request": "$request", '
                         '"http_host": "$host", '
                         '"url": "$uri", '
                         '"request_method": "$request_method", '
                         '"http_referrer": "$http_referer", '
                         '"http_x_forwarded_for": "$http_x_forwarded_for", '
                         '"http_user_agent": "$http_user_agent" } }';
        access_log  /var/log/nginx/access.log  main;

        sendfile        on;
        #tcp_nopush     on;

        keepalive_timeout  65;

        #gzip  on;

        include /etc/nginx/conf.d/*.conf;
        }

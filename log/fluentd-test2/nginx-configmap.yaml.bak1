kind: ConfigMap
apiVersion: v1
metadata:
  name: fluentd-config
data:
  containers.input.conf: |-   
    <source>
      @type tail
      path /usr/local/nginx/logs/access.log
      pos_file /usr/local/nginx/logs/access.log.pos
      tag nginx.access
        <parse>
          @type nginx
          expression /^(?<remote>[^ ]*) (?<host>[^ ]*) (?<user>[^ ]*) \[(?<time>[^\]]*)\] "(?<method>\S+)(?: +(?<path>[^\"]*?)(?: +\S*)?)?" (?<code>[^ ]*) (?<size>[^ ]*)(?: "(?<referer>[^\"]*)" "(?<agent>[^\"]*)"(?:\s+(?<http_x_forwarded_for>[^ ]+))?)?$/
          time_format %d/%b/%Y:%H:%M:%S %z
        </parse>
    </source>
  output.conf: |-
      <match nginx.access>
        @type elasticsearch
        host elasticsearch-service.monitor
        port 9200
        logstash_prefix nginx-access
        time_key time
        flush_interval 10s
        logstash_format true
      </match>
  nginx.conf: |-
    user  nginx;
    worker_processes  auto;

    error_log  /var/log/nginx/error.log notice;
    pid        /var/run/nginx.pid;


    events {
        worker_connections  1024;
    }


    http {
        include       /etc/nginx/mime.types;
        default_type  application/octet-stream;
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
        access_log  /var/log/nginx/access.log  main;

        sendfile        on;
        #tcp_nopush     on;

        keepalive_timeout  65;

        #gzip  on;

        include /etc/nginx/conf.d/*.conf;
        }

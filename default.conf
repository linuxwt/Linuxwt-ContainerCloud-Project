upstream zllms_admin_server{
    server 172.21.0.4:30005;
}

upstream zllms_api_server{
    server 172.21.0.4:30001;
}

upstream zllms_helper_server{
    server 172.21.0.17:30007;
}

upstream zllms_mobile_server{
    server 172.21.0.17:30006;
}

server {
    listen 80;
    #server_name localhost;

    access_log  /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    # 助手页面配置
    location / {
      alias /usr/share/nginx/html/helper-ui/;
      index index.html;
      try_files $uri $uri/ /index.html;
    }
    
    # LGM聚合平台页面配置
    location /admin {
      alias /usr/share/nginx/html/admin-ui/;
      index index.html;
      try_files $uri $uri/ /admin/index.html;
      location = /admin/index {
         return 301 /admin/;
      }
    }
    
    # LGM聚合平台移动注册页面配置
    location /mobile {
       alias /usr/share/nginx/html/mobile-ui/;
       if ( $uri = '/index.html' ) {
         add_header Cache-Control no-store always;
       }
       index index.html;
       try_files $uri $uri/ /mobile/index.html;
    }

    # LGM助手接口配置
    location /helper-service {
        rewrite ^/helper-service/(.*)$ /$1 break;# 如果后端接口不是统一以helper-service开头，去掉helper-service前缀
        # 设置默认上传文件大小限制为10MB
        client_max_body_size 10m;
        proxy_pass http://zllms_helper_server;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-For $http_x_forwarded_for;
        proxy_set_header http_user_agent $http_user_agent;
       # proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Proto http;
    }
    
    # LGM聚合平台接口配置
    location /admin-service {
        rewrite ^/admin-service/(.*)$ /$1 break;# 如果后端接口不是统一以admin开头，去掉admin前缀
        # 设置默认上传文件大小限制为10MB
        client_max_body_size 10m;
        proxy_pass http://zllms_admin_server;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-For $http_x_forwarded_for;
        proxy_set_header http_user_agent $http_user_agent;
        proxy_set_header X-Forwarded-Proto http;
    }
    
    
    # LGM聚合平台API接口配置
    location /api {
        rewrite ^/api/(.*)$ /$1 break;# 如果后端接口不是统一以api开头，去掉api前缀
        # 设置默认上传文件大小限制为10MB
        client_max_body_size 10m;
        proxy_pass http://zllms_api_server;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 300s;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-For $http_x_forwarded_for;
        proxy_set_header http_user_agent $http_user_agent;
        proxy_set_header X-Forwarded-Proto http;
    }
    
    # LGM聚合平台移动注册接口配置
    location /mobile-service {
        rewrite ^/mobile-service/(.*)$ /$1 break;# 如果后端接口不是统一以mobile开头，去掉mobile前缀
        # 设置默认上传文件大小限制为10MB
        client_max_body_size 10m;
        proxy_pass http://zllms_mobile_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-For $http_x_forwarded_for;
        proxy_set_header http_user_agent $http_user_agent;
        proxy_set_header X-Forwarded-Proto http;
    }


   # OSS图片下载配置
   location ^~/oss {
       rewrite ^/oss/(.*)$ /$1 break;
       proxy_pass http://xxxxx.aliyuncs.com;
       proxy_hide_header X-Content-Type-Options;
       proxy_set_header Host xxxxx.aliyuncs.com;
       proxy_set_header Connection close;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-Server $host;
    }
}